################################################################################
# makefile for test util
################################################################################

MAKE_INCLUDE_PATH=mk.inc

# ------------------------------------------------------------------------------
# Compiler and BIT
# ------------------------------------------------------------------------------
CC=gcc
BIT = 64

# ------------------------------------------------------------------------------
# debugger
# ------------------------------------------------------------------------------
DBGOPT = -g

# ------------------------------------------------------------------------------
# sources
# ------------------------------------------------------------------------------
SOURCES = mqbase.c mqreason.c

# ------------------------------------------------------------------------------
# main source
# ------------------------------------------------------------------------------
MAIN = 

# ------------------------------------------------------------------------------
# BINARY
# ------------------------------------------------------------------------------
BINARY = 

# ------------------------------------------------------------------------------
# libraries dynamic & static
# ------------------------------------------------------------------------------
LIBRARY = libmqutil.so 

ARCHIVE  =  libmqutil.a

# ------------------------------------------------------------------------------
# rollout includes
# ------------------------------------------------------------------------------
ROLLOUT_INC = 

# ------------------------------------------------------------------------------
# general includes
# ------------------------------------------------------------------------------
include $(MAKE_INCLUDE_PATH)/general.modules.mk

# ------------------------------------------------------------------------------
# mqreason
# ------------------------------------------------------------------------------
MQRC = mqrc

$(TMP_PATH)/mqreason.tmp : Makefile
	$(MQRC) -R -f 0 -l 99999999999 | $(CUT) -b1-65 | $(GREP) -v "^$$" > $@

$(INCLUDE_PATH)/mqreason.h :  $(TMP_PATH)/mqreason.tmp 
	$(PERL) -n -e  '{         \
                chomp;            \
                /^\s*(\d+)\s+0x(\w+)\s+(\S+)/ ; $$i=$$1; $$n=$$3; \
                next unless $$n=~/^rrcI_/ ;    \
                printf( "#define %-40s %5d\n" ,$$n ,$$i); }'  $< >$@

$(SOURCE_PATH)/mqreason.c :  $(TMP_PATH)/mqreason.tmp   \
                             $(SOURCE_PATH)/mqreason.ss \
                             $(SOURCE_PATH)/mqreason.se 
	$(CP) $(SOURCE_PATH)/mqreason.ss $@
	$(PERL) -n -e  '{                                       \
                chomp;/^\s*(\d+)\s+0x(\w+)\s+(\S+)/;$$n=$$3;    \
                next unless ($$n=~/^MQRC_/||$$n=~/^rrcI_/);     \
                next if $$n=~/MQRC_CONVERTED_MSG_TOO_BIG/;      \
                next if $$n=~/MQRC_PAGESET_FULL/         ;      \
                printf( "    convert(%-40s) ;\n",$$n); }' $< >>$@
	$(CAT) $(SOURCE_PATH)/mqreason.se >> $@
	

cleanlocal :
	$(RM) include/mqreason.h
	$(RM) src/mqreason.c

# ------------------------------------------------------------------------------
# tests
# ------------------------------------------------------------------------------
include $(MAKE_INCLUDE_PATH)/test.mk

